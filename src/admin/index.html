<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/admin/admin.css">
  <title>Painel Admin</title>
</head>

<body>
  <div class="page">
    <section class="card" id="login-card">
      <h2>Acesso ao Painel</h2>
      <form class="form" id="login-form">
        <label class="field">
          <span>Usuario</span>
          <input type="text" id="login-username" required />
        </label>
        <label class="field">
          <span>Senha</span>
          <input type="password" id="login-password" required />
        </label>
        <button class="btn primary" type="submit">Entrar</button>
        <p class="helper">Usuario master padrao: <strong>master</strong> / senha: <strong>admin123</strong></p>
      </form>
    </section>

    <div id="app-shell" class="hidden">
      <header class="header">
        <div>
          <h1>Painel de Midias</h1>
          <p id="user-label">Gerencie uploads e organize a playlist do player.</p>
        </div>
        <div class="header-actions">
          <label class="group-switch hidden" id="group-switch-wrap">
            <span>Grupo</span>
            <select id="group-select"></select>
          </label>
          <div class="status" id="server-status">
            <span class="status-dot" id="status-dot"></span>
            <span id="status-text">Servidor ativo</span>
          </div>
          <button class="btn ghost" type="button" id="logout-btn">Sair</button>
        </div>
      </header>

      <main class="grid">
        <section class="card">
          <h2>Upload da Campanha</h2>
          <form class="form" id="upload-form">
            <label class="field">
              <span>Campanha</span>
              <select id="campaign-select" name="campaignId">
                <option value="">Carregando campanhas...</option>
              </select>
            </label>

            <div class="form hidden" id="campaign-create-wrap">
              <label class="field">
                <span>Nome da nova campanha</span>
                <input type="text" id="campaign-create-name" />
              </label>
              <label class="field">
                <span>Inicio</span>
                <input type="datetime-local" id="campaign-create-start" />
              </label>
              <label class="field">
                <span>Fim</span>
                <input type="datetime-local" id="campaign-create-end" />
              </label>
              <label class="field">
                <span>Prioridade</span>
                <input type="number" id="campaign-create-priority" min="1" value="1" />
              </label>
            </div>

            <label class="field">
              <span>Imagem da campanha</span>
              <input type="file" id="media-file" name="mediaFile" accept="image/*" required />
            </label>

            <label class="field">
              <span>Duracao de cada imagem (segundos)</span>
              <input type="number" id="duration" name="duration" min="1" value="5" required />
            </label>

            <button class="btn primary" type="submit">Enviar imagem</button>
          </form>
        </section>

        <section class="card">
          <div class="card-header">
            <h2>Campanhas do Grupo</h2>
            <button class="btn ghost" type="button" onclick="loadCampaigns()">Atualizar</button>
          </div>
          <ul id="campaign-list" class="users-list"></ul>
          <div id="campaign-slides-wrap" class="campaign-slides-wrap hidden">
            <p class="helper">Midias da campanha selecionada</p>
            <ul id="campaign-slides-list" class="playlist"></ul>
          </div>
        </section>
      </main>

      <section class="card settings">
        <div class="card-header">
          <h2>Preview do Player</h2>
          <button class="btn ghost" type="button" onclick="refreshPlayerPreview()">Atualizar</button>
        </div>
        <p id="running-campaign" class="helper">Carregando campanha em execucao...</p>
        <iframe id="player-preview" class="player-preview" src="/player"></iframe>
      </section>

      <section class="card settings">
        <div class="card-header">
          <h2>Configuracoes do Grupo</h2>
          <button class="btn ghost" type="button" onclick="loadSettings()">Atualizar</button>
        </div>
        <div class="form">
          <label class="field">
            <span>Cor de fundo</span>
            <input type="color" id="bg-color" value="#ffffff" />
          </label>
          <button class="btn primary" type="button" onclick="saveSettings()">Salvar cor</button>
          <form class="form-inline" id="default-image-form">
            <input type="hidden" name="groupId" id="default-image-group-id" />
            <input type="file" name="defaultImage" id="default-image-input" accept="image/*" required />
            <button class="btn ghost" type="submit">Salvar imagem padrao</button>
            <button class="btn danger" type="button" id="remove-default-image-btn">Excluir imagem padrao</button>
          </form>
          <div class="preview-wrap">
            <span class="preview-label">Imagem padrao atual</span>
            <img id="default-image-preview" class="default-preview hidden" alt="Imagem padrao" />
          </div>
        </div>
      </section>

      <section class="card settings hidden" id="users-card">
        <div class="card-header">
          <h2>Gestao de Usuarios</h2>
          <button class="btn ghost" type="button" onclick="loadUsers()">Atualizar</button>
        </div>
        <form class="form" id="create-user-form">
          <label class="field">
            <span>Usuario</span>
            <input type="text" id="new-username" required />
          </label>
          <label class="field">
            <span>Senha</span>
            <input type="password" id="new-password" required />
          </label>
          <label class="field">
            <span>Grupo</span>
            <select id="new-user-group"></select>
          </label>
          <button class="btn primary" type="submit">Criar usuario do grupo</button>
          <p class="helper" id="create-user-msg"></p>
        </form>
        <ul id="users-list" class="users-list"></ul>
      </section>

      <section class="card settings hidden" id="groups-order-card">
        <div class="card-header">
          <h2>Ordem dos Grupos no Player</h2>
          <button class="btn ghost" type="button" onclick="loadGroupOrder()">Atualizar</button>
        </div>
        <ul id="groups-order-list" class="users-list"></ul>
        <button class="btn primary" type="button" onclick="saveGroupOrder()">Salvar ordem</button>
      </section>

    </div>
  </div>

  <script>
    let currentUser = null
    let groups = []
    let groupOrder = []
    let campaigns = []
    let selectedCampaignViewId = null
    let selectedGroupId = null
    const GROUP_STORAGE_KEY = 'admin:selectedGroupId'

    const loginCard = document.getElementById('login-card')
    const appShell = document.getElementById('app-shell')
    const groupSelect = document.getElementById('group-select')
    const groupSwitchWrap = document.getElementById('group-switch-wrap')
    const usersCard = document.getElementById('users-card')
    const groupsOrderCard = document.getElementById('groups-order-card')
    const newUserGroup = document.getElementById('new-user-group')
    const campaignSelect = document.getElementById('campaign-select')
    const campaignCreateWrap = document.getElementById('campaign-create-wrap')
    const campaignCreateName = document.getElementById('campaign-create-name')
    const campaignCreateStart = document.getElementById('campaign-create-start')
    const campaignCreateEnd = document.getElementById('campaign-create-end')
    const campaignCreatePriority = document.getElementById('campaign-create-priority')
    const campaignSlidesWrap = document.getElementById('campaign-slides-wrap')
    const campaignSlidesList = document.getElementById('campaign-slides-list')

    function getGroupQuery() {
      return selectedGroupId ? `?groupId=${selectedGroupId}` : ''
    }

    function buildQuery(extra = {}) {
      const params = new URLSearchParams()
      if (selectedGroupId) params.set('groupId', String(selectedGroupId))
      Object.entries(extra).forEach(([key, value]) => {
        if (value !== null && value !== undefined && value !== '') {
          params.set(key, String(value))
        }
      })
      const query = params.toString()
      return query ? `?${query}` : ''
    }

    function readStoredGroupId() {
      const value = localStorage.getItem(GROUP_STORAGE_KEY)
      const id = Number(value)
      return Number.isInteger(id) && id > 0 ? id : null
    }

    function storeGroupId(groupId) {
      if (!groupId) return
      localStorage.setItem(GROUP_STORAGE_KEY, String(groupId))
    }

    function syncGroupHiddenFields() {
      const defaultGroup = document.getElementById('default-image-group-id')
      if (defaultGroup) defaultGroup.value = selectedGroupId || ''
    }

    function renderAuth() {
      const userLabel = document.getElementById('user-label')
      if (!currentUser) {
        loginCard.classList.remove('hidden')
        appShell.classList.add('hidden')
        return
      }

      userLabel.textContent = `Usuario: ${currentUser.username} (${currentUser.role === 'master' ? 'master' : currentUser.groupName || 'grupo'})`
      loginCard.classList.add('hidden')
      appShell.classList.remove('hidden')

      if (currentUser.role === 'master') {
        groupSwitchWrap.classList.remove('hidden')
        usersCard.classList.remove('hidden')
        groupsOrderCard.classList.remove('hidden')
        groupSelect.innerHTML = ''
        newUserGroup.innerHTML = ''
        groups.forEach((group) => {
          const option = document.createElement('option')
          option.value = String(group.id)
          option.textContent = group.name
          groupSelect.appendChild(option)

          const userOption = document.createElement('option')
          userOption.value = String(group.id)
          userOption.textContent = group.name
          newUserGroup.appendChild(userOption)
        })
        groupSelect.value = String(selectedGroupId)
      } else {
        groupSwitchWrap.classList.add('hidden')
        usersCard.classList.add('hidden')
        groupsOrderCard.classList.add('hidden')
      }

      syncGroupHiddenFields()
    }

    async function requestJson(url, options = {}) {
      const res = await fetch(url, {
        credentials: 'same-origin',
        ...options
      })
      if (!res.ok) {
        const payload = await res.json().catch(() => ({}))
        throw new Error(payload.error || 'Falha na requisicao')
      }
      return res.json()
    }

    async function bootstrap() {
      try {
        const me = await requestJson('/auth/me')
        if (!me.authenticated) {
          currentUser = null
          renderAuth()
          return
        }

        currentUser = me.user
        groups = me.groups || []
        if (currentUser.role === 'master') {
          const storedGroupId = readStoredGroupId()
          const hasStoredGroup = groups.some((group) => group.id === storedGroupId)
          selectedGroupId = hasStoredGroup
            ? storedGroupId
            : (groups[0] ? groups[0].id : null)
        } else {
          selectedGroupId = currentUser.groupId
        }
        storeGroupId(selectedGroupId)

        renderAuth()
        await loadAllData()
      } catch (error) {
        currentUser = null
        renderAuth()
      }
    }

    async function loadAllData() {
      syncGroupHiddenFields()
      await Promise.all([loadSettings(), loadCampaigns(), loadRunningCampaign()])
      refreshPlayerPreview()
      if (currentUser && currentUser.role === 'master') {
        await loadUsers()
        await loadGroupOrder()
      }
    }

    async function loadSettings() {
      if (!selectedGroupId) return
      const settings = await requestJson(`/media/settings${getGroupQuery()}`)
      document.getElementById('bg-color').value = settings.background || '#ffffff'

      const preview = document.getElementById('default-image-preview')
      if (settings.defaultImage) {
        preview.src = settings.defaultImage
        preview.classList.remove('hidden')
      } else {
        preview.src = ''
        preview.classList.add('hidden')
      }
    }

    function renderCampaignOptions() {
      const previous = campaignSelect.value
      const isMaster = currentUser && currentUser.role === 'master'
      campaignSelect.innerHTML = ''

      if (isMaster) {
        campaignSelect.innerHTML += '<option value=\"\">Sem campanha (somente master)</option>'
      } else {
        campaignSelect.innerHTML += '<option value=\"\" disabled>Selecione uma campanha</option>'
      }

      campaignSelect.innerHTML += '<option value=\"__create__\">+ Criar nova campanha</option>'
      campaigns.forEach((campaign) => {
        const option = document.createElement('option')
        option.value = String(campaign.id)
        option.textContent = `${campaign.name} (${campaign.status})`
        campaignSelect.appendChild(option)
      })

      const exists = [...campaignSelect.options].some((opt) => opt.value === previous)
      if (exists) {
        campaignSelect.value = previous
      } else if (!isMaster && campaigns.length) {
        campaignSelect.value = String(campaigns[0].id)
      } else if (!isMaster) {
        campaignSelect.value = '__create__'
      } else {
        campaignSelect.value = ''
      }

      const selectedId = Number(campaignSelect.value)
      if (Number.isInteger(selectedId) && selectedId > 0) {
        selectedCampaignViewId = selectedId
      } else if (!selectedCampaignViewId && campaigns.length) {
        selectedCampaignViewId = campaigns[0].id
      }
      toggleCampaignCreateForm()
    }

    function renderCampaignList() {
      const list = document.getElementById('campaign-list')
      list.innerHTML = ''

      if (!campaigns.length) {
        const li = document.createElement('li')
        li.className = 'user-item'
        li.innerHTML = '<span>Nenhuma campanha cadastrada para este grupo</span>'
        list.appendChild(li)
        return
      }

      campaigns.forEach((campaign) => {
        const li = document.createElement('li')
        li.className = 'user-item'
        if (selectedCampaignViewId === campaign.id) {
          li.classList.add('selected')
        }
        li.innerHTML = `
          <strong>${campaign.name}</strong>
          <span class="campaign-status ${campaign.status}">${campaign.status.toUpperCase()}</span>
          <span>${new Date(campaign.startsAt).toLocaleString('pt-BR')} - ${new Date(campaign.endsAt).toLocaleString('pt-BR')}</span>
          <div class="actions">
            <button class="btn ghost" onclick="selectCampaignForView(${campaign.id})">Abrir</button>
            <button class="btn danger" onclick="deleteCampaign(${campaign.id})">Excluir</button>
          </div>
        `
        list.appendChild(li)
      })
    }

    function toggleCampaignCreateForm() {
      const creating = campaignSelect.value === '__create__'
      campaignCreateWrap.classList.toggle('hidden', !creating)
      campaignCreateName.required = creating
      campaignCreateStart.required = creating
      campaignCreateEnd.required = creating
    }

    async function loadCampaigns() {
      if (!selectedGroupId) return
      campaigns = await requestJson(`/media/campaigns${getGroupQuery()}`)
      const selectedExists = campaigns.some((campaign) => campaign.id === selectedCampaignViewId)
      if (!selectedExists) {
        selectedCampaignViewId = campaigns.length ? campaigns[0].id : null
      }
      renderCampaignOptions()
      renderCampaignList()
      await loadCampaignSlides()
    }

    function selectCampaignForView(campaignId) {
      selectedCampaignViewId = Number(campaignId) || null
      if (selectedCampaignViewId) {
        campaignSelect.value = String(selectedCampaignViewId)
      }
      renderCampaignList()
      loadCampaignSlides()
    }

    function renderCampaignSlides(slides) {
      campaignSlidesList.innerHTML = ''
      if (!selectedCampaignViewId) {
        campaignSlidesWrap.classList.add('hidden')
        return
      }

      campaignSlidesWrap.classList.remove('hidden')
      if (!slides.length) {
        const li = document.createElement('li')
        li.className = 'playlist-item'
        li.innerHTML = '<div class="info"><div class="title">Nenhuma imagem nesta campanha</div></div>'
        campaignSlidesList.appendChild(li)
        return
      }

      slides.forEach((slide) => {
        const li = document.createElement('li')
        li.className = 'playlist-item'
        const durationSeconds = Math.max(1, Math.round(Number(slide.duration || 5000) / 1000))
        const thumb = slide.type === 'image'
          ? `<div class="media"><img src="${slide.src}" alt="${slide.name || 'slide'}" /></div>`
          : `<div class="type ${slide.type}">${String(slide.type || 'midia').toUpperCase()}</div>`

        li.innerHTML = `
          ${thumb}
          <div class="info">
            <div class="title">${slide.name || 'Sem nome'}</div>
            <div class="meta">
              <span class="kind">${String(slide.type || 'midia').toUpperCase()}</span>
              <label class="slide-duration-edit">
                <span>Duracao (s)</span>
                <input type="number" min="1" id="slide-duration-${slide.id}" value="${durationSeconds}" />
              </label>
            </div>
          </div>
          <div class="actions">
            <button class="btn ghost" onclick="updateCampaignSlide(${slide.id})">Salvar</button>
            <button class="btn danger" onclick="deleteCampaignSlide(${slide.id})">Excluir</button>
          </div>
        `
        campaignSlidesList.appendChild(li)
      })
    }

    async function loadCampaignSlides() {
      if (!selectedGroupId || !selectedCampaignViewId) {
        renderCampaignSlides([])
        return
      }
      const slides = await requestJson(`/media/campaigns/slides${buildQuery({ campaignId: selectedCampaignViewId })}`)
      renderCampaignSlides(Array.isArray(slides) ? slides : [])
    }

    async function updateCampaignSlide(slideId) {
      const input = document.getElementById(`slide-duration-${slideId}`)
      const duration = Number(input?.value || 0)
      if (!Number.isFinite(duration) || duration <= 0) {
        alert('Informe uma duracao valida em segundos')
        return
      }

      await requestJson('/media/campaigns/slides/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ slideId, duration, groupId: selectedGroupId })
      })
      await loadCampaignSlides()
      await loadRunningCampaign()
      refreshPlayerPreview()
    }

    async function deleteCampaignSlide(slideId) {
      if (!confirm('Deseja excluir esta imagem da campanha?')) return
      await requestJson('/media/campaigns/slides/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ slideId, groupId: selectedGroupId })
      })
      await loadCampaignSlides()
      await loadRunningCampaign()
      refreshPlayerPreview()
    }

    async function deleteCampaign(campaignId) {
      if (!confirm('Deseja excluir esta campanha?')) return
      await requestJson('/media/campaigns/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ campaignId, groupId: selectedGroupId })
      })
      await loadCampaigns()
      await loadRunningCampaign()
    }

    async function loadRunningCampaign() {
      if (!selectedGroupId) return
      const payload = await requestJson(`/media/playlist/active${getGroupQuery()}`)
      const label = document.getElementById('running-campaign')
      if (payload.campaign) {
        label.textContent = `Executando: ${payload.campaign.name} (${payload.slides.length} slides)`
      } else {
        label.textContent = `Executando: base sem campanha (${payload.slides.length} slides)`
      }
    }

    function refreshPlayerPreview() {
      if (!selectedGroupId) return
      const frame = document.getElementById('player-preview')
      frame.src = `/player?groupId=${selectedGroupId}&_=${Date.now()}`
    }

    async function saveSettings() {
      if (!selectedGroupId) return
      const background = document.getElementById('bg-color').value
      await requestJson('/media/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ background, groupId: selectedGroupId })
      })
    }

    async function loadUsers() {
      if (!currentUser || currentUser.role !== 'master') return
      const users = await requestJson('/auth/users')
      const list = document.getElementById('users-list')
      list.innerHTML = ''

      users
        .filter((item) => item.role === 'group_user')
        .forEach((item) => {
          const li = document.createElement('li')
          li.className = 'user-item'
          li.innerHTML = `
            <strong>${item.username}</strong>
            <span>${item.groupName || 'Sem grupo'}</span>
            <span>${Number(item.active) === 1 ? 'Ativo' : 'Inativo'}</span>
          `
          list.appendChild(li)
        })
    }

    function renderGroupOrder() {
      const list = document.getElementById('groups-order-list')
      list.innerHTML = ''

      groupOrder.forEach((group, index) => {
        const li = document.createElement('li')
        li.className = 'user-item'
        li.innerHTML = `
          <strong>${group.name}</strong>
          <span>#${index + 1}</span>
          <div class="actions">
            <button class="btn ghost" onclick="moveGroup(${index}, -1)">↑</button>
            <button class="btn ghost" onclick="moveGroup(${index}, 1)">↓</button>
          </div>
        `
        list.appendChild(li)
      })
    }

    async function loadGroupOrder() {
      if (!currentUser || currentUser.role !== 'master') return
      const list = await requestJson('/media/groups')
      groups = list
      groupOrder = [...list]
      if (!selectedGroupId && groupOrder.length) {
        selectedGroupId = groupOrder[0].id
        storeGroupId(selectedGroupId)
      }
      renderAuth()
      renderGroupOrder()
    }

    function moveGroup(index, dir) {
      const newIndex = index + dir
      if (newIndex < 0 || newIndex >= groupOrder.length) return
      const temp = groupOrder[index]
      groupOrder[index] = groupOrder[newIndex]
      groupOrder[newIndex] = temp
      renderGroupOrder()
    }

    async function saveGroupOrder() {
      if (!groupOrder.length) return
      const order = groupOrder.map((group) => group.id)
      await requestJson('/media/groups/reorder', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ order })
      })
    }

    async function checkServerStatus() {
      const dot = document.getElementById('status-dot')
      const text = document.getElementById('status-text')
      try {
        const res = await fetch('/auth/me', { cache: 'no-store' })
        if (!res.ok) throw new Error('offline')
        dot.classList.remove('offline')
        text.textContent = 'Servidor ativo'
      } catch (error) {
        dot.classList.add('offline')
        text.textContent = 'Servidor offline'
      }
    }

    function setDuration(seconds) {
      const input = document.getElementById('duration')
      if (!input) return
      input.value = Math.max(1, Math.round(seconds))
    }

    function handleMediaChange(event) {
      const files = event.target.files
      if (!files || !files.length) return
      setDuration(5)
    }

    document.getElementById('login-form').addEventListener('submit', async (event) => {
      event.preventDefault()
      const username = document.getElementById('login-username').value.trim()
      const password = document.getElementById('login-password').value

      try {
        const payload = await requestJson('/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        })

        currentUser = payload.user
        groups = payload.groups || []
        if (currentUser.role === 'master') {
          const storedGroupId = readStoredGroupId()
          const hasStoredGroup = groups.some((group) => group.id === storedGroupId)
          selectedGroupId = hasStoredGroup
            ? storedGroupId
            : (groups[0] ? groups[0].id : null)
        } else {
          selectedGroupId = currentUser.groupId
        }
        storeGroupId(selectedGroupId)

        renderAuth()
        await loadAllData()
      } catch (error) {
        alert(error.message)
      }
    })

    document.getElementById('logout-btn').addEventListener('click', async () => {
      await requestJson('/auth/logout', { method: 'POST' })
      currentUser = null
      groups = []
      campaigns = []
      selectedCampaignViewId = null
      selectedGroupId = null
      renderAuth()
    })

    document.getElementById('create-user-form').addEventListener('submit', async (event) => {
      event.preventDefault()
      const msg = document.getElementById('create-user-msg')
      msg.textContent = ''

      const username = document.getElementById('new-username').value.trim()
      const password = document.getElementById('new-password').value
      const groupId = Number(document.getElementById('new-user-group').value)

      try {
        await requestJson('/auth/users', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password, groupId })
        })
        msg.textContent = 'Usuario criado com sucesso.'
        document.getElementById('create-user-form').reset()
        await loadUsers()
      } catch (error) {
        msg.textContent = error.message
      }
    })

    document.getElementById('upload-form').addEventListener('submit', async (event) => {
      event.preventDefault()
      if (!selectedGroupId) {
        return
      }

      const isMaster = currentUser && currentUser.role === 'master'
      const selectedCampaign = campaignSelect.value
      const fileInput = document.getElementById('media-file')

      if (!fileInput.files || !fileInput.files[0]) {
        alert('Selecione uma imagem')
        return
      }

      if (!isMaster && !selectedCampaign) {
        alert('Selecione ou crie uma campanha para enviar a midia')
        return
      }

      try {
        const form = new FormData()
        form.append('groupId', String(selectedGroupId))
        form.append('duration', String(document.getElementById('duration').value || 5))
        if (selectedCampaign) form.append('campaignId', selectedCampaign)

        if (selectedCampaign === '__create__') {
          const name = campaignCreateName.value.trim()
          const startsAtRaw = campaignCreateStart.value
          const endsAtRaw = campaignCreateEnd.value
          const priority = Number(campaignCreatePriority.value || 1)

          if (!name || !startsAtRaw || !endsAtRaw) {
            alert('Preencha os dados da nova campanha antes de enviar a midia')
            return
          }

          form.append('campaignName', name)
          form.append('startsAt', new Date(startsAtRaw).toISOString())
          form.append('endsAt', new Date(endsAtRaw).toISOString())
          form.append('priority', String(priority))
        }

        form.append('mediaFile', fileInput.files[0])

        const res = await fetch('/media/campaigns/upload', {
          method: 'POST',
          body: form,
          credentials: 'same-origin'
        })
        if (!res.ok) {
          const payload = await res.json().catch(() => ({}))
          throw new Error(payload.error || 'Falha ao enviar imagens da campanha')
        }
        const payload = await res.json().catch(() => ({}))

        const selectedAfterUpload = payload.campaignId
          ? String(payload.campaignId)
          : campaignSelect.value
        event.target.reset()
        campaignSelect.value = selectedAfterUpload
        campaignCreateWrap.classList.add('hidden')
        await loadCampaigns()
        if (selectedAfterUpload && selectedAfterUpload !== '__create__') {
          selectedCampaignViewId = Number(selectedAfterUpload)
        }
        await loadCampaignSlides()
        await loadRunningCampaign()
        refreshPlayerPreview()
      } catch (error) {
        alert(error.message)
      }
    })

    groupSelect.addEventListener('change', async (event) => {
      selectedGroupId = Number(event.target.value)
      storeGroupId(selectedGroupId)
      await loadAllData()
    })

    campaignSelect.addEventListener('change', () => {
      const selectedId = Number(campaignSelect.value)
      selectedCampaignViewId = Number.isInteger(selectedId) && selectedId > 0 ? selectedId : null
      toggleCampaignCreateForm()
      renderCampaignList()
      loadCampaignSlides()
    })

    document.getElementById('default-image-form').addEventListener('submit', async (event) => {
      event.preventDefault()
      if (!selectedGroupId) return

      const input = document.getElementById('default-image-input')
      if (!input.files || !input.files[0]) return

      const form = new FormData()
      form.append('defaultImage', input.files[0])
      form.append('groupId', String(selectedGroupId))

      const res = await fetch('/media/default-image', {
        method: 'POST',
        body: form,
        credentials: 'same-origin'
      })

      if (!res.ok) {
        const payload = await res.json().catch(() => ({}))
        alert(payload.error || 'Falha ao salvar imagem padrao')
        return
      }

      await loadSettings()
      input.value = ''
    })

    document.getElementById('remove-default-image-btn').addEventListener('click', async () => {
      if (!selectedGroupId) return
      if (!confirm('Deseja remover a imagem padrao deste grupo?')) return

      try {
        await requestJson('/media/default-image/remove', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ groupId: selectedGroupId })
        })
        await loadSettings()
      } catch (error) {
        alert(error.message)
      }
    })

    const mediaInput = document.getElementById('media-file')
    if (mediaInput) {
      mediaInput.addEventListener('change', handleMediaChange)
    }

    window.addEventListener('online', checkServerStatus)
    window.addEventListener('offline', checkServerStatus)
    setInterval(checkServerStatus, 5000)

    bootstrap()
    checkServerStatus()
  </script>
</body>

</html>
