<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/x-icon" href="/assets/system-logo.ico" />
  <link rel="stylesheet" href="/admin/admin.css">
  <title>Painel Admin</title>
</head>

<body>
  <div class="page">
    <section class="card" id="login-card">
      <h2>Acesso ao Painel</h2>
      <form class="form" id="login-form">
        <label class="field">
          <span>Usuario</span>
          <input type="text" id="login-username" required />
        </label>
        <label class="field">
          <span>Senha</span>
          <input type="password" id="login-password" required />
        </label>
        <button class="btn primary" type="submit">Entrar</button>
        <!--<p class="helper">Usuario master padrao: <strong>master</strong> / senha: <strong>admin123</strong></p>-->
      </form>
    </section>

    <div id="app-shell" class="hidden">
      <header class="header">
        <div>
          <h1>Painel de Midias</h1>
          <p id="user-label">Gerencie uploads e organize a playlist do player.</p>
        </div>
        <div class="header-actions">
          <label class="group-switch hidden" id="group-switch-wrap">
            <span>Grupo</span>
            <select id="group-select"></select>
          </label>
          <a href="/admin/sql" class="btn ghost hidden" id="sql-console-link">SQL</a>
          <div class="status" id="server-status">
            <span class="status-dot" id="status-dot"></span>
            <span id="status-text">Servidor ativo</span>
          </div>
          <button class="btn ghost" type="button" id="logout-btn">Sair</button>
        </div>
      </header>

      <main class="grid">
        <section class="card">
          <h2>Upload da Campanha</h2>
          <form class="form" id="upload-form">
            <label class="field">
              <span>Campanha</span>
              <div class="campaign-select-row">
                <select id="campaign-select" name="campaignId">
                  <option value="">Carregando campanhas...</option>
                </select>
                <button type="button" class="btn ghost" id="open-campaign-modal-btn">Nova campanha</button>
              </div>
            </label>

            <label class="field">
              <span>Imagem da campanha</span>
              <input type="file" id="media-file" name="mediaFile" accept="image/*" required />
            </label>

            <label class="field">
              <span>Nome da imagem</span>
              <input type="text" id="media-name" name="name" placeholder="Ex: capa_operacao" required />
            </label>

            <label class="field">
              <span>Duracao de cada imagem (segundos)</span>
              <input type="number" id="duration" name="duration" min="1" value="5" required />
            </label>

            <!--<label class="field hidden" id="protect-slide-wrap">
              <span>
                <input type="checkbox" id="protect-slide" name="protectSlide" value="1" />
                Proteger slide (somente master pode mover/excluir)
              </span>
            </label>-->

            <button class="btn primary" type="submit">Enviar imagem</button>
          </form>
        </section>

        <section class="card">
          <div class="card-header">
            <h2>Campanhas do Grupo</h2>
            <button class="btn ghost" type="button" onclick="loadCampaigns()">Atualizar</button>
          </div>
          <ul id="campaign-list" class="users-list"></ul>
          <div id="cover-slides-wrap" class="campaign-slides-wrap">
            <p class="helper" id="cover-slides-title">Capas do grupo (somente master)</p>
            <ul id="cover-slides-list" class="playlist"></ul>
          </div>
          <div id="campaign-slides-wrap" class="campaign-slides-wrap">
            <p class="helper" id="campaign-slides-title">Midias da campanha selecionada</p>
            <ul id="campaign-slides-list" class="playlist"></ul>
          </div>
        </section>
      </main>

      <section class="card settings">
        <div class="card-header">
          <h2>Preview do Player</h2>
          <button class="btn ghost" type="button" onclick="refreshPlayerPreview()">Atualizar</button>
        </div>
        <p id="running-campaign" class="helper">Carregando campanha em execucao...</p>
        <iframe id="player-preview" class="player-preview" src="/player"></iframe>
      </section>

      <section class="card settings hidden" id="settings-card">
        <div class="card-header">
          <h2>Configuracoes do Grupo</h2>
          <button class="btn ghost" type="button" onclick="loadSettings()">Atualizar</button>
        </div>
        <!--
          Configuracao de cor mantida para uso futuro.
          Quando reativar, manter visivel somente para master.
        <div class="form">
          <label class="field">
            <span>Cor de fundo</span>
            <input type="color" id="bg-color" value="#ffffff" />
          </label>
          <button class="btn primary" type="button" onclick="saveSettings()">Salvar cor</button>
        </div>
        -->
        <div class="form">
          <!--
          <form class="form-inline" id="default-image-form">
            <input type="hidden" name="groupId" id="default-image-group-id" />
            <input type="file" name="defaultImage" id="default-image-input" accept="image/*" required />
            <button class="btn ghost" type="submit">Salvar imagem padrao</button>
            <button class="btn danger" type="button" id="remove-default-image-btn">Excluir imagem padrao</button>
          </form>
          <div class="preview-wrap">
            <span class="preview-label">Imagem padrao atual</span>
            <img id="default-image-preview" class="default-preview hidden" alt="Imagem padrao" />
          </div>
          -->
          <p class="helper">Configuracoes visuais desativadas no momento.</p>
        </div>
      </section>

      <section class="card settings hidden" id="users-card">
        <div class="card-header">
          <h2>Gestao de Usuarios</h2>
          <button class="btn ghost" type="button" onclick="refreshUsersAndGroups()">Atualizar</button>
        </div>
        <div class="management-grid">
          <section class="management-panel">
            <div class="panel-header">
              <h3>Usuarios</h3>
              <button class="btn primary" type="button" id="open-user-modal-btn">Criar usuario</button>
            </div>
            <ul id="users-list" class="users-list"></ul>
          </section>
          <section class="management-panel">
            <div class="panel-header">
              <h3>Grupos</h3>
              <button class="btn primary" type="button" id="open-group-modal-btn">Criar grupo</button>
            </div>
            <ul id="groups-list" class="users-list"></ul>
          </section>
        </div>
        <p class="helper" id="create-user-msg"></p>
      </section>

      <section class="card settings hidden" id="groups-order-card">
        <div class="card-header">
          <h2>Ordem dos Grupos no Player</h2>
          <button class="btn ghost" type="button" onclick="loadGroupOrder()">Atualizar</button>
        </div>
        <ul id="groups-order-list" class="users-list"></ul>
        <button class="btn primary" type="button" onclick="saveGroupOrder()">Salvar ordem</button>
      </section>

    </div>
  </div>

  <div id="campaign-modal" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-labelledby="campaign-modal-title">
    <div class="modal-card">
      <div class="card-header">
        <h2 id="campaign-modal-title">Nova Campanha</h2>
        <button type="button" class="btn ghost" id="close-campaign-modal-btn">Fechar</button>
      </div>
      <div class="form">
        <label class="field">
          <span>Nome da campanha</span>
          <input type="text" id="campaign-create-name" />
        </label>
        <label class="field">
          <span>Inicio</span>
          <input type="datetime-local" id="campaign-create-start" />
        </label>
        <label class="field">
          <span>Fim</span>
          <input type="datetime-local" id="campaign-create-end" />
        </label>
        <label class="field">
          <span>Prioridade</span>
          <input type="number" id="campaign-create-priority" min="1" value="1" />
        </label>
        <div class="modal-actions">
          <button type="button" class="btn ghost" id="cancel-campaign-modal-btn">Cancelar</button>
          <button type="button" class="btn primary" id="save-campaign-modal-btn">Salvar campanha</button>
        </div>
      </div>
    </div>
  </div>

  <div id="user-modal" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-labelledby="user-modal-title">
    <div class="modal-card">
      <div class="card-header">
        <h2 id="user-modal-title">Criar Usuario</h2>
        <button type="button" class="btn ghost" id="close-user-modal-btn">Fechar</button>
      </div>
      <form class="form" id="create-user-form">
        <label class="field">
          <span>Usuario</span>
          <input type="text" id="new-username" required />
        </label>
        <label class="field">
          <span>Senha</span>
          <input type="password" id="new-password" required />
        </label>
        <label class="field">
          <span>Grupo</span>
          <select id="new-user-group"></select>
        </label>
        <div class="modal-actions">
          <button type="button" class="btn ghost" id="cancel-user-modal-btn">Cancelar</button>
          <button class="btn primary" type="submit">Criar usuario</button>
        </div>
      </form>
    </div>
  </div>

  <div id="group-modal" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-labelledby="group-modal-title">
    <div class="modal-card">
      <div class="card-header">
        <h2 id="group-modal-title">Criar Grupo</h2>
        <button type="button" class="btn ghost" id="close-group-modal-btn">Fechar</button>
      </div>
      <form class="form" id="create-group-form">
        <label class="field">
          <span>Nome do grupo</span>
          <input type="text" id="new-group-name" required />
        </label>
        <div class="modal-actions">
          <button type="button" class="btn ghost" id="cancel-group-modal-btn">Cancelar</button>
          <button class="btn primary" type="submit">Criar grupo</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let currentUser = null
    let groups = []
    let groupOrder = []
    let campaigns = []
    let selectedCampaignViewId = null
    let selectedGroupId = null
    let isAutoRefreshingAdmin = false
    let autoRefreshMs = 15000
    let campaignModalMode = 'create'
    let editingCampaignId = null
    const GROUP_STORAGE_KEY = 'admin:selectedGroupId'

    const loginCard = document.getElementById('login-card')
    const appShell = document.getElementById('app-shell')
    const groupSelect = document.getElementById('group-select')
    const groupSwitchWrap = document.getElementById('group-switch-wrap')
    const usersCard = document.getElementById('users-card')
    const groupsOrderCard = document.getElementById('groups-order-card')
    const settingsCard = document.getElementById('settings-card')
    const sqlConsoleLink = document.getElementById('sql-console-link')
    const protectSlideWrap = document.getElementById('protect-slide-wrap')
    const protectSlideInput = document.getElementById('protect-slide')
    const newUserGroup = document.getElementById('new-user-group')
    const usersList = document.getElementById('users-list')
    const groupsList = document.getElementById('groups-list')
    const userModal = document.getElementById('user-modal')
    const groupModal = document.getElementById('group-modal')
    const openUserModalBtn = document.getElementById('open-user-modal-btn')
    const openGroupModalBtn = document.getElementById('open-group-modal-btn')
    const closeUserModalBtn = document.getElementById('close-user-modal-btn')
    const closeGroupModalBtn = document.getElementById('close-group-modal-btn')
    const cancelUserModalBtn = document.getElementById('cancel-user-modal-btn')
    const cancelGroupModalBtn = document.getElementById('cancel-group-modal-btn')
    const campaignSelect = document.getElementById('campaign-select')
    const campaignModal = document.getElementById('campaign-modal')
    const openCampaignModalBtn = document.getElementById('open-campaign-modal-btn')
    const closeCampaignModalBtn = document.getElementById('close-campaign-modal-btn')
    const cancelCampaignModalBtn = document.getElementById('cancel-campaign-modal-btn')
    const saveCampaignModalBtn = document.getElementById('save-campaign-modal-btn')
    const campaignModalTitle = document.getElementById('campaign-modal-title')
    const campaignCreateName = document.getElementById('campaign-create-name')
    const campaignCreateStart = document.getElementById('campaign-create-start')
    const campaignCreateEnd = document.getElementById('campaign-create-end')
    const campaignCreatePriority = document.getElementById('campaign-create-priority')
    const coverSlidesWrap = document.getElementById('cover-slides-wrap')
    const coverSlidesList = document.getElementById('cover-slides-list')
    const coverSlidesTitle = document.getElementById('cover-slides-title')
    const campaignSlidesWrap = document.getElementById('campaign-slides-wrap')
    const campaignSlidesList = document.getElementById('campaign-slides-list')
    const campaignSlidesTitle = document.getElementById('campaign-slides-title')

    function getGroupQuery() {
      return selectedGroupId ? `?groupId=${selectedGroupId}` : ''
    }

    function buildQuery(extra = {}) {
      const params = new URLSearchParams()
      if (selectedGroupId) params.set('groupId', String(selectedGroupId))
      Object.entries(extra).forEach(([key, value]) => {
        if (value !== null && value !== undefined && value !== '') {
          params.set(key, String(value))
        }
      })
      const query = params.toString()
      return query ? `?${query}` : ''
    }

    function readStoredGroupId() {
      const value = localStorage.getItem(GROUP_STORAGE_KEY)
      const id = Number(value)
      return Number.isInteger(id) && id > 0 ? id : null
    }

    function storeGroupId(groupId) {
      if (!groupId) return
      localStorage.setItem(GROUP_STORAGE_KEY, String(groupId))
    }

    function syncGroupHiddenFields() {
      const defaultGroup = document.getElementById('default-image-group-id')
      if (defaultGroup) defaultGroup.value = selectedGroupId || ''
    }

    function openModal(modalEl) {
      modalEl.classList.remove('hidden')
      document.body.classList.add('modal-open')
    }

    function closeModal(modalEl) {
      modalEl.classList.add('hidden')
      if (
        userModal.classList.contains('hidden') &&
        groupModal.classList.contains('hidden') &&
        campaignModal.classList.contains('hidden')
      ) {
        document.body.classList.remove('modal-open')
      }
    }

    function closeAllModals() {
      closeModal(campaignModal)
      closeModal(userModal)
      closeModal(groupModal)
    }

    function openCampaignModal(mode = 'create', campaign = null) {
      campaignModalMode = mode
      editingCampaignId = campaign && campaign.id ? Number(campaign.id) : null
      campaignModalTitle.textContent = mode === 'edit' ? 'Editar Campanha' : 'Nova Campanha'
      saveCampaignModalBtn.textContent = mode === 'edit' ? 'Salvar alteracoes' : 'Salvar campanha'

      if (mode === 'edit' && campaign) {
        campaignCreateName.value = campaign.name || ''
        campaignCreateStart.value = toDatetimeLocal(campaign.startsAt)
        campaignCreateEnd.value = toDatetimeLocal(campaign.endsAt)
        campaignCreatePriority.value = Number(campaign.priority || 1)
      } else {
        campaignCreateName.value = ''
        campaignCreateStart.value = ''
        campaignCreateEnd.value = ''
        campaignCreatePriority.value = 1
      }

      openModal(campaignModal)
      setTimeout(() => campaignCreateName.focus(), 30)
    }

    function closeCampaignModal() {
      campaignModalMode = 'create'
      editingCampaignId = null
      closeModal(campaignModal)
    }

    function toDatetimeLocal(value) {
      const date = new Date(value)
      if (Number.isNaN(date.getTime())) return ''
      const pad = (n) => String(n).padStart(2, '0')
      return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`
    }

    function renderAuth() {
      const userLabel = document.getElementById('user-label')
      if (!currentUser) {
        loginCard.classList.remove('hidden')
        appShell.classList.add('hidden')
        return
      }

      userLabel.textContent = `Usuario: ${currentUser.username} (${currentUser.role === 'master' ? 'master' : currentUser.groupName || 'grupo'})`
      loginCard.classList.add('hidden')
      appShell.classList.remove('hidden')

      if (currentUser.role === 'master') {
        groupSwitchWrap.classList.remove('hidden')
        usersCard.classList.remove('hidden')
        groupsOrderCard.classList.remove('hidden')
        sqlConsoleLink.classList.remove('hidden')
        if (settingsCard) settingsCard.classList.add('hidden')
        if (protectSlideWrap) protectSlideWrap.classList.remove('hidden')
        groupSelect.innerHTML = ''
        newUserGroup.innerHTML = ''
        groups.forEach((group) => {
          const option = document.createElement('option')
          option.value = String(group.id)
          option.textContent = group.name
          groupSelect.appendChild(option)

          const userOption = document.createElement('option')
          userOption.value = String(group.id)
          userOption.textContent = group.name
          newUserGroup.appendChild(userOption)
        })
        groupSelect.value = String(selectedGroupId)
      } else {
        groupSwitchWrap.classList.add('hidden')
        usersCard.classList.add('hidden')
        groupsOrderCard.classList.add('hidden')
        sqlConsoleLink.classList.add('hidden')
        if (settingsCard) settingsCard.classList.add('hidden')
        if (protectSlideWrap) protectSlideWrap.classList.add('hidden')
        if (protectSlideInput) protectSlideInput.checked = false
      }

      syncGroupHiddenFields()
    }

    async function requestJson(url, options = {}) {
      const res = await fetch(url, {
        credentials: 'same-origin',
        ...options
      })
      if (!res.ok) {
        const payload = await res.json().catch(() => ({}))
        throw new Error(payload.error || 'Falha na requisicao')
      }
      return res.json()
    }

    async function loadRuntimeConfig() {
      try {
        const payload = await requestJson('/media/runtime-config', { cache: 'no-store' })
        const value = Number(payload?.autoRefreshMs)
        if (Number.isFinite(value) && value >= 5000) {
          autoRefreshMs = value
        }
      } catch (error) {
        // keep default interval
      }
    }

    async function bootstrap() {
      try {
        const me = await requestJson('/auth/me')
        if (!me.authenticated) {
          currentUser = null
          renderAuth()
          return
        }

        currentUser = me.user
        groups = me.groups || []
        if (currentUser.role === 'master') {
          selectedGroupId = groups[0] ? groups[0].id : null
        } else {
          selectedGroupId = currentUser.groupId
        }
        storeGroupId(selectedGroupId)

        renderAuth()
        await loadAllData()
      } catch (error) {
        currentUser = null
        renderAuth()
      }
    }

    async function loadAllData() {
      syncGroupHiddenFields()
      await Promise.all([loadSettings(), loadCampaigns(), loadRunningCampaign()])
      refreshPlayerPreview()
      if (currentUser && currentUser.role === 'master') {
        await refreshUsersAndGroups()
        await loadGroupOrder()
      }
    }

    async function autoRefreshAdmin() {
      if (!currentUser || !selectedGroupId || isAutoRefreshingAdmin) return
      isAutoRefreshingAdmin = true
      try {
        await Promise.all([loadCampaigns(), loadRunningCampaign()])
      } catch (error) {
        // ignore transient network errors in automatic refresh
      } finally {
        isAutoRefreshingAdmin = false
      }
    }

    async function refreshUsersAndGroups() {
      await Promise.all([loadUsers(), loadGroupsList()])
    }

    async function loadSettings() {
      if (!selectedGroupId) return
      const settings = await requestJson(`/media/settings${getGroupQuery()}`)
      const bgColor = document.getElementById('bg-color')
      if (bgColor) {
        bgColor.value = settings.background || '#ffffff'
      }

      const preview = document.getElementById('default-image-preview')
      if (preview && settings.defaultImage) {
        preview.src = settings.defaultImage
        preview.classList.remove('hidden')
      } else if (preview) {
        preview.src = ''
        preview.classList.add('hidden')
      }
    }

    function renderCampaignOptions(preferredCampaignId = null) {
      const previous = campaignSelect.value
      const isMaster = currentUser && currentUser.role === 'master'
      campaignSelect.innerHTML = ''

      if (isMaster) {
        campaignSelect.innerHTML += '<option value=\"\">Sem campanha (somente master)</option>'
      } else if (!campaigns.length) {
        campaignSelect.innerHTML += '<option value=\"\" selected disabled>Nenhuma campanha (clique em Nova campanha)</option>'
      } else {
        campaignSelect.innerHTML += '<option value=\"\" disabled>Selecione uma campanha</option>'
      }
      campaigns.forEach((campaign) => {
        const option = document.createElement('option')
        option.value = String(campaign.id)
        option.textContent = `${campaign.name} (${campaign.status})`
        campaignSelect.appendChild(option)
      })

      const preferred = preferredCampaignId ? String(preferredCampaignId) : null
      const hasPreferred = preferred
        ? [...campaignSelect.options].some((opt) => opt.value === preferred)
        : false
      const exists = [...campaignSelect.options].some((opt) => opt.value === previous)
      if (hasPreferred) {
        campaignSelect.value = preferred
      } else if (exists) {
        campaignSelect.value = previous
      } else if (!isMaster && campaigns.length) {
        campaignSelect.value = String(campaigns[0].id)
      } else {
        campaignSelect.value = ''
      }

      const selectedId = Number(campaignSelect.value)
      if (Number.isInteger(selectedId) && selectedId > 0) {
        selectedCampaignViewId = selectedId
      } else if (!selectedCampaignViewId && campaigns.length) {
        selectedCampaignViewId = campaigns[0].id
      }
    }

    function renderCampaignList() {
      const list = document.getElementById('campaign-list')
      list.innerHTML = ''

      if (!campaigns.length) {
        const li = document.createElement('li')
        li.className = 'user-item'
        li.innerHTML = '<span>Nenhuma campanha cadastrada para este grupo</span>'
        list.appendChild(li)
        return
      }

      campaigns.forEach((campaign) => {
        const li = document.createElement('li')
        li.className = 'user-item'
        li.style.cursor = 'pointer'
        li.addEventListener('click', () => selectCampaignForView(campaign.id))
        if (selectedCampaignViewId === campaign.id) {
          li.classList.add('selected')
        }
        li.innerHTML = `
          <strong>${campaign.name}</strong>
          <span class="campaign-status ${campaign.status}">${campaign.status.toUpperCase()}</span>
          <span>${new Date(campaign.startsAt).toLocaleString('pt-BR')} - ${new Date(campaign.endsAt).toLocaleString('pt-BR')}</span>
          <div class="actions">
            <button class="btn ghost" type="button" data-action="edit-campaign">Editar</button>
            <button class="btn danger" type="button" data-action="delete-campaign">Excluir</button>
          </div>
        `
        const editBtn = li.querySelector('[data-action="edit-campaign"]')
        const deleteBtn = li.querySelector('[data-action="delete-campaign"]')
        editBtn.addEventListener('click', (event) => {
          event.stopPropagation()
          editCampaignSchedule(campaign.id)
        })
        deleteBtn.addEventListener('click', (event) => {
          event.stopPropagation()
          deleteCampaign(campaign.id)
        })
        list.appendChild(li)
      })
    }

    async function loadCampaigns(preferredCampaignId = null) {
      if (!selectedGroupId) return
      campaigns = await requestJson(`/media/campaigns${getGroupQuery()}`)
      if (preferredCampaignId) {
        selectedCampaignViewId = Number(preferredCampaignId)
      }
      const selectedExists = campaigns.some((campaign) => campaign.id === selectedCampaignViewId)
      if (!selectedExists) {
        selectedCampaignViewId = campaigns.length ? campaigns[0].id : null
      }
      renderCampaignOptions(preferredCampaignId)
      renderCampaignList()
      await Promise.all([loadCoverSlides(), loadCampaignSlides()])
    }

    function selectCampaignForView(campaignId) {
      selectedCampaignViewId = Number(campaignId) || null
      if (selectedCampaignViewId) {
        campaignSelect.value = String(selectedCampaignViewId)
      }
      renderCampaignList()
      loadCampaignSlides()
    }

    function renderSlideList(listEl, slides, options = {}) {
      const {
        emptyText = 'Nenhuma imagem',
        moveHandler = 'moveCampaignSlide',
        saveHandler = 'updateCampaignSlide',
        deleteHandler = 'deleteCampaignSlide',
        readonly = false
      } = options
      listEl.innerHTML = ''

      if (!slides.length) {
        const li = document.createElement('li')
        li.className = 'playlist-item empty-item'
        li.innerHTML = `<div class="info"><p class="title">${emptyText}</p></div>`
        listEl.appendChild(li)
        return
      }

      slides.forEach((slide, index) => {
        const li = document.createElement('li')
        li.className = 'playlist-item'
        const durationSeconds = Math.max(1, Math.round(Number(slide.duration || 5000) / 1000))
        const thumb = slide.type === 'image'
          ? `<div class="media"><img src="${slide.src}" alt="${slide.name || 'slide'}" /></div>`
          : `<div class="type ${slide.type}">${String(slide.type || 'midia').toUpperCase()}</div>`

        li.innerHTML = `
          ${thumb}
          <div class="info">
            <div class="title">${slide.name || 'Sem nome'}</div>
            <div class="meta">
              <span class="kind">${String(slide.type || 'midia').toUpperCase()}</span>
              <label class="slide-duration-edit">
                <span>Duracao (s)</span>
                <input type="number" min="1" id="slide-duration-${slide.id}" value="${durationSeconds}" ${readonly ? 'disabled' : ''} />
              </label>
            </div>
          </div>
          <div class="actions">
            <button class="btn ghost" onclick="${moveHandler}(${slide.id}, -1)" ${readonly || index === 0 ? 'disabled' : ''}>↑</button>
            <button class="btn ghost" onclick="${moveHandler}(${slide.id}, 1)" ${readonly || index === slides.length - 1 ? 'disabled' : ''}>↓</button>
            <button class="btn ghost" onclick="${saveHandler}(${slide.id})" ${readonly ? 'disabled' : ''}>Salvar</button>
            <button class="btn danger" onclick="${deleteHandler}(${slide.id})" ${readonly ? 'disabled' : ''}>Excluir</button>
          </div>
        `
        listEl.appendChild(li)
      })
    }

    function renderCoverSlides(slides) {
      const isMaster = currentUser && currentUser.role === 'master'
      coverSlidesWrap.classList.remove('hidden')
      coverSlidesTitle.textContent = isMaster
        ? 'Capas do grupo (somente master)'
        : 'Capas do grupo'
      renderSlideList(coverSlidesList, slides, {
        emptyText: 'Nenhuma capa cadastrada para este grupo',
        moveHandler: 'moveCoverSlide',
        saveHandler: 'updateCoverSlide',
        deleteHandler: 'deleteCoverSlide',
        readonly: !isMaster
      })
    }

    function renderCampaignSlides(slides) {
      campaignSlidesWrap.classList.remove('hidden')
      campaignSlidesTitle.textContent = 'Midias da campanha selecionada'
      renderSlideList(campaignSlidesList, slides, {
        emptyText: selectedCampaignViewId
          ? 'Nenhuma imagem nesta campanha'
          : 'Selecione uma campanha para visualizar as midias',
        moveHandler: 'moveCampaignSlide',
        saveHandler: 'updateCampaignSlide',
        deleteHandler: 'deleteCampaignSlide',
        readonly: !selectedCampaignViewId
      })
    }

    async function loadCoverSlides() {
      if (!selectedGroupId) {
        renderCoverSlides([])
        return
      }
      const slides = await requestJson(`/media/campaigns/slides${buildQuery({ campaignId: 'base' })}`)
      renderCoverSlides(Array.isArray(slides) ? slides : [])
    }

    async function loadCampaignSlides() {
      if (!selectedGroupId || !selectedCampaignViewId) {
        renderCampaignSlides([])
        return
      }
      const slides = await requestJson(`/media/campaigns/slides${buildQuery({ campaignId: selectedCampaignViewId })}`)
      renderCampaignSlides(Array.isArray(slides) ? slides : [])
    }

    async function moveSlide(slideId, dir) {
      await requestJson('/media/campaigns/slides/reorder', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ slideId, dir, groupId: selectedGroupId })
      })
    }

    async function moveCampaignSlide(slideId, dir) {
      await moveSlide(slideId, dir)
      await loadCampaignSlides()
      await loadRunningCampaign()
      refreshPlayerPreview()
    }

    async function updateSlide(slideId) {
      const input = document.getElementById(`slide-duration-${slideId}`)
      const duration = Number(input?.value || 0)
      if (!Number.isFinite(duration) || duration <= 0) {
        alert('Informe uma duracao valida em segundos')
        return
      }

      await requestJson('/media/campaigns/slides/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ slideId, duration, groupId: selectedGroupId })
      })
    }

    async function updateCampaignSlide(slideId) {
      await updateSlide(slideId)
      await loadCampaignSlides()
      await loadRunningCampaign()
      refreshPlayerPreview()
    }

    async function deleteSlide(slideId) {
      if (!confirm('Deseja excluir esta imagem da campanha?')) return
      await requestJson('/media/campaigns/slides/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ slideId, groupId: selectedGroupId })
      })
    }

    async function deleteCampaignSlide(slideId) {
      await deleteSlide(slideId)
      await loadCampaignSlides()
      await loadRunningCampaign()
      refreshPlayerPreview()
    }

    async function moveCoverSlide(slideId, dir) {
      await moveSlide(slideId, dir)
      await loadCoverSlides()
      await loadRunningCampaign()
      refreshPlayerPreview()
    }

    async function updateCoverSlide(slideId) {
      await updateSlide(slideId)
      await loadCoverSlides()
      await loadRunningCampaign()
      refreshPlayerPreview()
    }

    async function deleteCoverSlide(slideId) {
      await deleteSlide(slideId)
      await loadCoverSlides()
      await loadRunningCampaign()
      refreshPlayerPreview()
    }

    async function deleteCampaign(campaignId) {
      if (!confirm('Deseja excluir esta campanha?')) return
      await requestJson('/media/campaigns/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ campaignId, groupId: selectedGroupId })
      })
      await loadCampaigns()
      await loadRunningCampaign()
    }

    function editCampaignSchedule(campaignId) {
      const campaign = campaigns.find((item) => item.id === Number(campaignId))
      if (!campaign) return
      openCampaignModal('edit', campaign)
    }

    async function createCampaignFromModal() {
      if (!selectedGroupId) return
      const name = campaignCreateName.value.trim()
      const startsAtRaw = campaignCreateStart.value
      const endsAtRaw = campaignCreateEnd.value
      const priority = Number(campaignCreatePriority.value || 1)

      if (!name || !startsAtRaw || !endsAtRaw) {
        alert('Preencha nome, inicio e fim da campanha')
        return
      }
      if (new Date(startsAtRaw).getTime() >= new Date(endsAtRaw).getTime()) {
        alert('Data/hora de fim deve ser maior que a de inicio')
        return
      }

      const payload = {
        groupId: selectedGroupId,
        name,
        startsAt: new Date(startsAtRaw).toISOString(),
        endsAt: new Date(endsAtRaw).toISOString(),
        priority
      }

      if (campaignModalMode === 'edit' && Number.isInteger(editingCampaignId) && editingCampaignId > 0) {
        await requestJson('/media/campaigns/update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ...payload, campaignId: editingCampaignId })
        })
        await loadCampaigns(editingCampaignId)
        campaignSelect.value = String(editingCampaignId)
        selectedCampaignViewId = editingCampaignId
      } else {
        const created = await requestJson('/media/campaigns', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        })
        const createdId = Number(created?.id)
        await loadCampaigns(createdId)
        if (Number.isInteger(createdId) && createdId > 0) {
          campaignSelect.value = String(createdId)
          selectedCampaignViewId = createdId
        }
      }
      closeCampaignModal()
    }

    async function loadRunningCampaign() {
      if (!selectedGroupId) return
      const payload = await requestJson(`/media/playlist/active${getGroupQuery()}`)
      const label = document.getElementById('running-campaign')
      if (payload.campaign) {
        label.textContent = `Executando: ${payload.campaign.name} (${payload.slides.length} slides)`
      } else {
        label.textContent = `Executando: base sem campanha (${payload.slides.length} slides)`
      }
    }

    function refreshPlayerPreview() {
      if (!selectedGroupId) return
      const frame = document.getElementById('player-preview')
      frame.src = `/player?groupId=${selectedGroupId}&_=${Date.now()}`
    }

    async function saveSettings() {
      if (!selectedGroupId) return
      const bgColor = document.getElementById('bg-color')
      if (!bgColor) return
      const background = bgColor.value
      await requestJson('/media/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ background, groupId: selectedGroupId })
      })
    }

    async function loadUsers() {
      if (!currentUser || currentUser.role !== 'master') return
      const users = await requestJson('/auth/users')
      usersList.innerHTML = ''

      users
        .filter((item) => item.role === 'group_user')
        .forEach((item) => {
          const li = document.createElement('li')
          li.className = 'user-item'
          li.innerHTML = `
            <strong>${item.username}</strong>
            <span>${item.groupName || 'Sem grupo'}</span>
            <span>${Number(item.active) === 1 ? 'Ativo' : 'Inativo'}</span>
          `
          usersList.appendChild(li)
        })
    }

    async function loadGroupsList() {
      if (!currentUser || currentUser.role !== 'master') return
      const list = await requestJson('/media/groups')
      groupsList.innerHTML = ''
      list.forEach((group) => {
        const li = document.createElement('li')
        li.className = 'user-item'
        li.innerHTML = `
          <strong>${group.name}</strong>
          <span>Ordem #${group.displayOrder || '-'}</span>
        `
        groupsList.appendChild(li)
      })
    }

    function renderGroupOrder() {
      const list = document.getElementById('groups-order-list')
      list.innerHTML = ''

      groupOrder.forEach((group, index) => {
        const li = document.createElement('li')
        li.className = 'user-item'
        li.innerHTML = `
          <strong>${group.name}</strong>
          <span>#${index + 1}</span>
          <div class="actions">
            <button class="btn ghost" onclick="moveGroup(${index}, -1)">↑</button>
            <button class="btn ghost" onclick="moveGroup(${index}, 1)">↓</button>
          </div>
        `
        list.appendChild(li)
      })
    }

    async function loadGroupOrder() {
      if (!currentUser || currentUser.role !== 'master') return
      const list = await requestJson('/media/groups')
      groups = list
      groupOrder = [...list]
      if (!selectedGroupId && groupOrder.length) {
        selectedGroupId = groupOrder[0].id
        storeGroupId(selectedGroupId)
      }
      renderAuth()
      renderGroupOrder()
    }

    function moveGroup(index, dir) {
      const newIndex = index + dir
      if (newIndex < 0 || newIndex >= groupOrder.length) return
      const temp = groupOrder[index]
      groupOrder[index] = groupOrder[newIndex]
      groupOrder[newIndex] = temp
      renderGroupOrder()
    }

    async function saveGroupOrder() {
      if (!groupOrder.length) return
      const order = groupOrder.map((group) => group.id)
      await requestJson('/media/groups/reorder', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ order })
      })
    }

    async function checkServerStatus() {
      const dot = document.getElementById('status-dot')
      const text = document.getElementById('status-text')
      try {
        const res = await fetch('/auth/me', { cache: 'no-store' })
        if (!res.ok) throw new Error('offline')
        dot.classList.remove('offline')
        text.textContent = 'Servidor ativo'
      } catch (error) {
        dot.classList.add('offline')
        text.textContent = 'Servidor offline'
      }
    }

    function setDuration(seconds) {
      const input = document.getElementById('duration')
      if (!input) return
      input.value = Math.max(1, Math.round(seconds))
    }

    function handleMediaChange(event) {
      const files = event.target.files
      if (!files || !files.length) return
      const nameInput = document.getElementById('media-name')
      if (nameInput && !nameInput.value.trim()) {
        nameInput.value = files[0].name.replace(/\.[^.]+$/, '')
      }
      setDuration(5)
    }

    document.getElementById('login-form').addEventListener('submit', async (event) => {
      event.preventDefault()
      const username = document.getElementById('login-username').value.trim()
      const password = document.getElementById('login-password').value

      try {
        const payload = await requestJson('/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        })

        currentUser = payload.user
        groups = payload.groups || []
        if (currentUser.role === 'master') {
          selectedGroupId = groups[0] ? groups[0].id : null
        } else {
          selectedGroupId = currentUser.groupId
        }
        storeGroupId(selectedGroupId)

        renderAuth()
        await loadAllData()
      } catch (error) {
        alert(error.message)
      }
    })

    document.getElementById('logout-btn').addEventListener('click', async () => {
      await requestJson('/auth/logout', { method: 'POST' })
      currentUser = null
      groups = []
      campaigns = []
      selectedCampaignViewId = null
      selectedGroupId = null
      closeAllModals()
      renderAuth()
    })

    document.getElementById('create-user-form').addEventListener('submit', async (event) => {
      event.preventDefault()
      const msg = document.getElementById('create-user-msg')
      msg.textContent = ''

      const username = document.getElementById('new-username').value.trim()
      const password = document.getElementById('new-password').value
      const groupId = Number(document.getElementById('new-user-group').value)

      try {
        await requestJson('/auth/users', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password, groupId })
        })
        msg.textContent = 'Usuario criado com sucesso.'
        document.getElementById('create-user-form').reset()
        closeModal(userModal)
        await refreshUsersAndGroups()
      } catch (error) {
        msg.textContent = error.message
      }
    })

    document.getElementById('create-group-form').addEventListener('submit', async (event) => {
      event.preventDefault()
      const msg = document.getElementById('create-user-msg')
      msg.textContent = ''
      const name = document.getElementById('new-group-name').value.trim()

      try {
        await requestJson('/auth/groups', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name })
        })

        document.getElementById('create-group-form').reset()
        closeModal(groupModal)

        groups = await requestJson('/media/groups')
        if (!selectedGroupId && groups.length) {
          selectedGroupId = groups[0].id
          storeGroupId(selectedGroupId)
        }
        renderAuth()
        await Promise.all([refreshUsersAndGroups(), loadGroupOrder(), loadCampaigns(), loadSettings(), loadRunningCampaign()])
        refreshPlayerPreview()
      } catch (error) {
        msg.textContent = error.message
      }
    })

    document.getElementById('upload-form').addEventListener('submit', async (event) => {
      event.preventDefault()
      if (!selectedGroupId) {
        return
      }

      const isMaster = currentUser && currentUser.role === 'master'
      const selectedCampaign = campaignSelect.value
      const selectedCampaignId = Number(selectedCampaign)
      const fileInput = document.getElementById('media-file')

      if (!fileInput.files || !fileInput.files[0]) {
        alert('Selecione uma imagem')
        return
      }

      if (!isMaster && (!Number.isInteger(selectedCampaignId) || selectedCampaignId <= 0)) {
        alert('Selecione ou crie uma campanha para enviar a midia')
        return
      }

      try {
        const form = new FormData()
        form.append('groupId', String(selectedGroupId))
        form.append('duration', String(document.getElementById('duration').value || 5))
        form.append('name', String(document.getElementById('media-name').value || '').trim())
        if (Number.isInteger(selectedCampaignId) && selectedCampaignId > 0) {
          form.append('campaignId', String(selectedCampaignId))
        }
        if (protectSlideInput && protectSlideInput.checked) form.append('protectSlide', '1')

        form.append('mediaFile', fileInput.files[0])

        const res = await fetch('/media/campaigns/upload', {
          method: 'POST',
          body: form,
          credentials: 'same-origin'
        })
        if (!res.ok) {
          const payload = await res.json().catch(() => ({}))
          throw new Error(payload.error || 'Falha ao enviar imagens da campanha')
        }
        const payload = await res.json().catch(() => ({}))

        const selectedAfterUpload = payload.campaignId
          ? String(payload.campaignId)
          : campaignSelect.value
        event.target.reset()
        campaignSelect.value = selectedAfterUpload
        closeCampaignModal()
        await loadCampaigns()
        if (selectedAfterUpload) {
          selectedCampaignViewId = Number(selectedAfterUpload)
        }
        await loadCampaignSlides()
        await loadRunningCampaign()
        refreshPlayerPreview()
      } catch (error) {
        alert(error.message)
      }
    })

    groupSelect.addEventListener('change', async (event) => {
      selectedGroupId = Number(event.target.value)
      storeGroupId(selectedGroupId)
      closeAllModals()
      await loadAllData()
    })

    campaignSelect.addEventListener('change', () => {
      const selectedId = Number(campaignSelect.value)
      selectedCampaignViewId = Number.isInteger(selectedId) && selectedId > 0 ? selectedId : null
      if (campaignSelect.value !== '') {
        if (protectSlideInput) protectSlideInput.checked = false
      }
      renderCampaignList()
      loadCampaignSlides()
    })

    openCampaignModalBtn.addEventListener('click', () => {
      openCampaignModal()
    })

    closeCampaignModalBtn.addEventListener('click', closeCampaignModal)
    cancelCampaignModalBtn.addEventListener('click', closeCampaignModal)

    saveCampaignModalBtn.addEventListener('click', createCampaignFromModal)

    campaignModal.addEventListener('click', (event) => {
      if (event.target === campaignModal) {
        closeCampaignModal()
      }
    })

    openUserModalBtn.addEventListener('click', () => {
      openModal(userModal)
      setTimeout(() => document.getElementById('new-username').focus(), 30)
    })

    openGroupModalBtn.addEventListener('click', () => {
      openModal(groupModal)
      setTimeout(() => document.getElementById('new-group-name').focus(), 30)
    })

    closeUserModalBtn.addEventListener('click', () => closeModal(userModal))
    closeGroupModalBtn.addEventListener('click', () => closeModal(groupModal))
    cancelUserModalBtn.addEventListener('click', () => closeModal(userModal))
    cancelGroupModalBtn.addEventListener('click', () => closeModal(groupModal))

    userModal.addEventListener('click', (event) => {
      if (event.target === userModal) closeModal(userModal)
    })

    groupModal.addEventListener('click', (event) => {
      if (event.target === groupModal) closeModal(groupModal)
    })

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') {
        closeAllModals()
      }
    })

    const defaultImageForm = document.getElementById('default-image-form')
    if (defaultImageForm) {
      defaultImageForm.addEventListener('submit', async (event) => {
        event.preventDefault()
        if (!selectedGroupId) return

        const input = document.getElementById('default-image-input')
        if (!input || !input.files || !input.files[0]) return

        const form = new FormData()
        form.append('defaultImage', input.files[0])
        form.append('groupId', String(selectedGroupId))

        const res = await fetch('/media/default-image', {
          method: 'POST',
          body: form,
          credentials: 'same-origin'
        })

        if (!res.ok) {
          const payload = await res.json().catch(() => ({}))
          alert(payload.error || 'Falha ao salvar imagem padrao')
          return
        }

        await loadSettings()
        input.value = ''
      })
    }

    const removeDefaultImageBtn = document.getElementById('remove-default-image-btn')
    if (removeDefaultImageBtn) {
      removeDefaultImageBtn.addEventListener('click', async () => {
        if (!selectedGroupId) return
        if (!confirm('Deseja remover a imagem padrao deste grupo?')) return

        try {
          await requestJson('/media/default-image/remove', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ groupId: selectedGroupId })
          })
          await loadSettings()
        } catch (error) {
          alert(error.message)
        }
      })
    }

    const mediaInput = document.getElementById('media-file')
    if (mediaInput) {
      mediaInput.addEventListener('change', handleMediaChange)
    }

    window.addEventListener('online', checkServerStatus)
    window.addEventListener('offline', checkServerStatus)
    setInterval(checkServerStatus, 5000)

    ;(async () => {
      await loadRuntimeConfig()
      setInterval(autoRefreshAdmin, autoRefreshMs)
      await bootstrap()
      checkServerStatus()
    })()
  </script>
</body>

</html>
