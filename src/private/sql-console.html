<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SQL Console (Master)</title>
  <style>
    :root {
      --bg: #0e161b;
      --panel: #131f26;
      --panel-2: #182730;
      --text: #e6eef2;
      --muted: #9fb5c0;
      --accent: #00c2ff;
      --danger: #ff6b6b;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Trebuchet MS", Verdana, Arial, sans-serif;
      background: radial-gradient(circle at top left, #1f313a 0%, #0e161b 55%);
      color: var(--text);
      min-height: 100vh;
    }
    .layout {
      max-width: 1450px;
      margin: 0 auto;
      padding: 16px;
      display: grid;
      grid-template-columns: minmax(260px, 320px) minmax(0, 1fr);
      gap: 14px;
    }
    .card {
      background: linear-gradient(145deg, var(--panel), var(--panel-2));
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px;
      padding: 12px;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      gap: 8px;
    }
    h1, h2, h3 { margin: 0; }
    h1 { font-size: 20px; }
    h2 { font-size: 16px; }
    .muted { color: var(--muted); font-size: 12px; }
    .editor {
      width: 100%;
      min-height: 280px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.14);
      background: #081218;
      color: #eaf8ff;
      font-family: Consolas, "Courier New", monospace;
      font-size: 14px;
      line-height: 1.5;
      padding: 12px;
      resize: vertical;
    }
    .row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .btn {
      border: none;
      border-radius: 8px;
      padding: 9px 12px;
      font-weight: 700;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
    }
    .btn.primary { background: linear-gradient(135deg, var(--accent), #00a1ff); color: #04141c; }
    .btn.ghost { background: rgba(255,255,255,0.08); color: var(--text); border: 1px solid rgba(255,255,255,0.12); }
    .btn.danger { background: rgba(255,107,107,0.15); color: #ffd6d6; border: 1px solid rgba(255,107,107,0.35); }
    .status {
      margin-top: 10px;
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 13px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.08);
      white-space: pre-wrap;
    }
    .status.error {
      background: rgba(255,107,107,0.12);
      border-color: rgba(255,107,107,0.4);
      color: #ffd2d2;
    }
    .table-wrap {
      margin-top: 10px;
      max-height: 420px;
      overflow: auto;
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    th, td {
      border-bottom: 1px solid rgba(255,255,255,0.08);
      padding: 8px;
      text-align: left;
      vertical-align: top;
    }
    th {
      position: sticky;
      top: 0;
      background: #0b161d;
      z-index: 1;
    }
    .schema-list, .history-list {
      list-style: none;
      margin: 10px 0 0;
      padding: 0;
      display: grid;
      gap: 8px;
      max-height: 78vh;
      overflow: auto;
    }
    .schema-item, .history-item {
      background: rgba(0,0,0,0.2);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 8px;
      padding: 8px;
      font-size: 12px;
    }
    .schema-item strong {
      display: inline-block;
      margin-bottom: 6px;
      font-size: 13px;
    }
    .columns {
      display: grid;
      gap: 3px;
      color: var(--muted);
    }
    .history-item button {
      margin-top: 8px;
      font-size: 12px;
      padding: 4px 8px;
    }
    @media (max-width: 980px) {
      .layout { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="card">
      <div class="header">
        <h2>Schema</h2>
        <button id="refresh-schema" class="btn ghost" type="button">Atualizar</button>
      </div>
      <p class="muted">Somente master. Execute 1 comando por vez.</p>
      <ul id="schema-list" class="schema-list"></ul>
      <hr style="border-color: rgba(255,255,255,0.08); margin: 12px 0;">
      <div class="header">
        <h2>Query History</h2>
        <button id="clear-history" class="btn danger" type="button">Limpar</button>
      </div>
      <ul id="history-list" class="history-list"></ul>
    </aside>

    <main class="card">
      <div class="header">
        <h1>SQL Console</h1>
        <a href="/admin" class="btn ghost">Voltar ao Admin</a>
      </div>
      <textarea id="sql-editor" class="editor" spellcheck="false">SELECT id, name, campaign_id, position, is_locked
FROM slides
ORDER BY group_id, campaign_id, position, id;</textarea>
      <div class="row">
        <button id="run-sql" class="btn primary" type="button">Executar</button>
        <button id="format-sql" class="btn ghost" type="button">Uppercase comando</button>
      </div>
      <div id="status" class="status">Pronto.</div>
      <div id="output" class="table-wrap"></div>
    </main>
  </div>

  <script>
    const schemaList = document.getElementById('schema-list')
    const historyList = document.getElementById('history-list')
    const sqlEditor = document.getElementById('sql-editor')
    const statusEl = document.getElementById('status')
    const outputEl = document.getElementById('output')
    const HISTORY_KEY = 'sql-console-history'

    function setStatus(message, isError = false) {
      statusEl.textContent = message
      statusEl.classList.toggle('error', isError)
    }

    function getHistory() {
      try {
        const value = localStorage.getItem(HISTORY_KEY)
        const parsed = value ? JSON.parse(value) : []
        return Array.isArray(parsed) ? parsed : []
      } catch (error) {
        return []
      }
    }

    function saveHistory(sql) {
      if (!sql || !sql.trim()) return
      const entries = getHistory().filter((item) => item !== sql)
      entries.unshift(sql)
      localStorage.setItem(HISTORY_KEY, JSON.stringify(entries.slice(0, 20)))
      renderHistory()
    }

    function renderHistory() {
      const items = getHistory()
      historyList.innerHTML = ''
      if (!items.length) {
        historyList.innerHTML = '<li class="history-item">Sem historico.</li>'
        return
      }

      items.forEach((sql) => {
        const li = document.createElement('li')
        li.className = 'history-item'
        li.innerHTML = `
          <div>${sql.replace(/</g, '&lt;')}</div>
          <button class="btn ghost" type="button">Usar</button>
        `
        li.querySelector('button').addEventListener('click', () => {
          sqlEditor.value = sql
          sqlEditor.focus()
        })
        historyList.appendChild(li)
      })
    }

    function renderRows(rows) {
      if (!Array.isArray(rows) || !rows.length) {
        outputEl.innerHTML = '<table><tbody><tr><td>Sem linhas retornadas.</td></tr></tbody></table>'
        return
      }
      const cols = Object.keys(rows[0])
      const thead = `<thead><tr>${cols.map((c) => `<th>${c}</th>`).join('')}</tr></thead>`
      const tbody = rows.map((row) => {
        return `<tr>${cols.map((c) => `<td>${String(row[c] == null ? '' : row[c]).replace(/</g, '&lt;')}</td>`).join('')}</tr>`
      }).join('')
      outputEl.innerHTML = `<table>${thead}<tbody>${tbody}</tbody></table>`
    }

    async function loadSchema() {
      try {
        const res = await fetch('/auth/sql/schema', { credentials: 'same-origin' })
        if (!res.ok) {
          const payload = await res.json().catch(() => ({}))
          throw new Error(payload.error || 'Falha ao carregar schema')
        }
        const payload = await res.json()
        const tables = Array.isArray(payload.tables) ? payload.tables : []
        schemaList.innerHTML = ''
        tables.forEach((table) => {
          const li = document.createElement('li')
          li.className = 'schema-item'
          const columns = (table.columns || [])
            .map((col) => `${col.name} (${col.type || 'TEXT'})${col.pk ? ' [PK]' : ''}`)
            .join('</div><div>')
          li.innerHTML = `
            <strong>${table.name}</strong>
            <div class="columns"><div>${columns || 'Sem colunas'}</div></div>
          `
          schemaList.appendChild(li)
        })
      } catch (error) {
        setStatus(error.message, true)
      }
    }

    async function executeSql() {
      const sql = sqlEditor.value.trim()
      if (!sql) return
      setStatus('Executando...')
      try {
        const res = await fetch('/auth/sql/execute', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({ sql })
        })
        const payload = await res.json().catch(() => ({}))
        if (!res.ok) throw new Error(payload.error || 'Falha ao executar SQL')

        saveHistory(sql)
        if (payload.mode === 'query') {
          setStatus(`OK. ${payload.rowCount} linha(s).`)
          renderRows(payload.rows || [])
          return
        }
        setStatus(`OK. changes=${payload.changes || 0}${payload.lastID ? `, lastID=${payload.lastID}` : ''}`)
        outputEl.innerHTML = '<table><tbody><tr><td>Comando executado com sucesso.</td></tr></tbody></table>'
        await loadSchema()
      } catch (error) {
        setStatus(error.message, true)
      }
    }

    document.getElementById('run-sql').addEventListener('click', executeSql)
    document.getElementById('refresh-schema').addEventListener('click', loadSchema)
    document.getElementById('clear-history').addEventListener('click', () => {
      localStorage.removeItem(HISTORY_KEY)
      renderHistory()
    })
    document.getElementById('format-sql').addEventListener('click', () => {
      const value = sqlEditor.value
      const match = value.match(/^\s*([a-z]+)/i)
      if (!match) return
      sqlEditor.value = value.replace(match[1], match[1].toUpperCase())
    })

    sqlEditor.addEventListener('keydown', (event) => {
      if ((event.ctrlKey || event.metaKey) && event.key === 'Enter') {
        event.preventDefault()
        executeSql()
      }
    })

    renderHistory()
    loadSchema()
  </script>
</body>
</html>
